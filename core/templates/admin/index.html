{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrahead %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div id="content-main" class="admin-layout admin-dashboard">
  <section class="admin-card admin-hero">
    <div class="admin-row cols-2 admin-row--vcenter">
      <div>
        <h1 class="admin-section-title">Academic RAG Admin Overview</h1>
        <p class="admin-muted">Realtime ringkas untuk kapasitas user, performa RAG, infrastruktur, dan akses cepat CRUD.</p>
      </div>
      <div class="admin-toolbar admin-toolbar--end">
        <span id="kpi-alert" class="admin-chip success">{{ kpi_alert_state }}</span>
        <span class="admin-chip"><span class="bi bi-clock"></span> Polling <span id="poll-label">{{ kpi_admin_poll_seconds|default:"5" }}</span>s</span>
        <button id="monitor-refresh" type="button" class="admin-btn primary"><span class="bi bi-arrow-repeat"></span> Refresh</button>
        <label class="admin-chip"><input id="monitor-auto" type="checkbox" checked> Auto</label>
      </div>
    </div>
  </section>

  <section class="admin-card">
    <h2 class="admin-card__title">Quick Actions CRUD</h2>
    <p class="admin-card__meta">Akses 1 klik ke changelist dan add form model yang paling sering dipakai.</p>
    <div class="admin-actions mt-12">
      {% for link in quick_admin_links %}
        <a class="admin-btn" href="{{ link.list_url }}"><span class="bi bi-grid-1x2"></span> {{ link.label }}</a>
        {% if link.add_url %}
          <a class="admin-btn" href="{{ link.add_url }}"><span class="bi bi-plus-circle"></span> {{ link.label }}</a>
        {% endif %}
      {% endfor %}
      <a class="admin-btn primary" href="{{ system_logs_url|default:'/admin/system-logs/' }}"><span class="bi bi-journal-text"></span> System Logs</a>
    </div>
  </section>

  <section class="admin-kpi-grid">
    <article class="admin-card kpi-card">
      <p class="kpi-card__label">Total Users</p>
      <p id="kpi-total-users" class="kpi-card__value">{{ kpi_total_users }}</p>
      <p class="kpi-card__sub">Non-staff: <span id="kpi-registered">{{ kpi_registered_non_staff_count }}</span></p>
    </article>
    <article class="admin-card kpi-card">
      <p class="kpi-card__label">Knowledge Base</p>
      <p id="kpi-total-docs" class="kpi-card__value">{{ kpi_total_docs }}</p>
      <p class="kpi-card__sub">Embedded: <span id="kpi-embedded-docs">{{ kpi_embedded_docs }}</span></p>
    </article>
    <article class="admin-card kpi-card">
      <p class="kpi-card__label">Chat Activity</p>
      <p id="kpi-total-messages" class="kpi-card__value">{{ kpi_total_messages }}</p>
      <p class="kpi-card__sub">Sessions: <span id="kpi-total-sessions">{{ kpi_total_sessions }}</span></p>
    </article>
    <article class="admin-card kpi-card">
      <p class="kpi-card__label">Online Users</p>
      <p id="kpi-online" class="kpi-card__value">{{ kpi_active_online_non_staff_count }}</p>
      <p class="kpi-card__sub">CPU/RAM/Disk: <span id="kpi-infra">{{ kpi_cpu_percent }}/{{ kpi_memory_percent }}/{{ kpi_disk_percent }}</span></p>
    </article>
    <article class="admin-card kpi-card">
      <p class="kpi-card__label">RAG Error Rate</p>
      <p id="kpi-rag-error" class="kpi-card__value">{{ kpi_rag_error_rate_pct }}%</p>
      <p class="kpi-card__sub">Fallback: <span id="kpi-rag-fallback">{{ kpi_rag_fallback_rate_pct }}%</span></p>
    </article>
    <article class="admin-card kpi-card">
      <p class="kpi-card__label">RAG Latency</p>
      <p class="kpi-card__value"><span id="rag-avg-retrieval">{{ kpi_avg_retrieval_ms }}</span> ms</p>
      <p class="kpi-card__sub">LLM: <span id="rag-avg-llm">{{ kpi_avg_llm_ms }}</span>ms · p95: <span id="rag-p95">{{ kpi_rag_p95_retrieval_ms }}</span>ms</p>
    </article>
    <article class="admin-card kpi-card">
      <p class="kpi-card__label">Infrastructure</p>
      <p class="kpi-card__value"><span id="infra-cpu">{{ kpi_cpu_percent }}</span>%</p>
      <p class="kpi-card__sub">RAM: <span id="infra-mem">{{ kpi_memory_percent }}</span>% · Disk: <span id="infra-disk">{{ kpi_disk_percent }}</span>%</p>
    </article>
    <article class="admin-card kpi-card">
      <p class="kpi-card__label">LLM Config</p>
      <p class="kpi-card__value"><span id="kpi-llm-active">{{ kpi_active_llm_configs }}</span>/<span id="kpi-llm-total">{{ kpi_total_llm_configs }}</span></p>
      <p class="kpi-card__sub">Maintenance: <span id="kpi-maintenance-state">{% if kpi_maintenance_enabled %}ON{% else %}OFF{% endif %}</span></p>
    </article>
  </section>

  <section class="admin-row cols-2">
    <article class="admin-card">
      <div class="admin-terminal-toolbar">
        <h2 class="admin-section-title">Registered Capacity</h2>
        <span id="registered-status" class="admin-chip">{{ kpi_registered_capacity_status }}</span>
      </div>
      <p class="admin-muted"><span id="registered-ratio">{{ kpi_registered_non_staff_count }}</span> / <span id="registered-limit">{{ kpi_registered_limit }}</span></p>
      <div class="capacity-track"><div id="registered-progress" class="capacity-fill" data-initial-pct="{{ kpi_registered_usage_pct|default:'0' }}"></div></div>
      <p class="admin-muted">Usage <span id="registered-pct">{{ kpi_registered_usage_pct }}</span>% · Limit <span id="register-limit-enabled">{% if kpi_registration_limit_enabled %}ON{% else %}OFF{% endif %}</span></p>
    </article>
    <article class="admin-card">
      <div class="admin-terminal-toolbar">
        <h2 class="admin-section-title">Concurrent Online Capacity</h2>
        <span id="online-status" class="admin-chip">{{ kpi_concurrent_capacity_status }}</span>
      </div>
      <p class="admin-muted"><span id="online-ratio">{{ kpi_active_online_non_staff_count }}</span> / <span id="online-limit">{{ kpi_concurrent_limit }}</span></p>
      <div class="capacity-track"><div id="online-progress" class="capacity-fill" data-initial-pct="{{ kpi_concurrent_usage_pct|default:'0' }}"></div></div>
      <p class="admin-muted">Usage <span id="online-pct">{{ kpi_concurrent_usage_pct }}</span>% · Limit <span id="concurrent-limit-enabled">{% if kpi_concurrent_limit_enabled %}ON{% else %}OFF{% endif %}</span></p>
    </article>
  </section>

  <section class="admin-row cols-2">
    <article class="admin-card">
      <div class="admin-terminal-toolbar">
        <h2 class="admin-section-title">Chart: Capacity Utilization</h2>
        <span class="admin-chip">Window realtime</span>
      </div>
      <p class="admin-muted admin-chart-meta">Registered vs concurrent usage dalam persen kapasitas.</p>
      <div class="admin-chart-wrap"><canvas id="chart-capacity" aria-label="Capacity utilization chart" role="img"></canvas></div>
    </article>
    <article class="admin-card">
      <div class="admin-terminal-toolbar">
        <h2 class="admin-section-title">Chart: RAG Reliability Mix</h2>
        <span class="admin-chip">Fallback <span id="rag-fallback-inline">{{ kpi_rag_fallback_rate_pct }}</span>%</span>
      </div>
      <p class="admin-muted admin-chart-meta">Distribusi status 2xx/4xx/5xx dari event RAG terbaru.</p>
      <div class="admin-chart-wrap"><canvas id="chart-rag-reliability" aria-label="RAG reliability mix chart" role="img"></canvas></div>
    </article>
  </section>

  <section class="admin-row cols-2">
    <article class="admin-card">
      <div class="admin-terminal-toolbar">
        <h2 class="admin-section-title">Chart: RAG Latency Trend</h2>
        <span class="admin-chip">p95 <span id="rag-p95-inline">{{ kpi_rag_p95_retrieval_ms }}</span>ms</span>
      </div>
      <p class="admin-muted">Avg retrieval <span id="rag-avg-retrieval-inline">{{ kpi_avg_retrieval_ms }}</span>ms · Avg llm <span id="rag-avg-llm-inline">{{ kpi_avg_llm_ms }}</span>ms</p>
      <div class="admin-chart-wrap"><canvas id="chart-rag-latency" aria-label="RAG latency trend chart" role="img"></canvas></div>
    </article>
    <article class="admin-card">
      <div class="admin-terminal-toolbar">
        <h2 class="admin-section-title">Chart: Infrastructure Trend</h2>
        <span id="alarm-state" class="admin-chip success">{{ kpi_alert_state }}</span>
      </div>
      <p class="admin-muted admin-chart-meta">Trend CPU, Memory, Disk dari snapshot infrastruktur.</p>
      <div class="admin-chart-wrap"><canvas id="chart-infra" aria-label="Infrastructure trend chart" role="img"></canvas></div>
    </article>
  </section>

  <section class="admin-row cols-2">
    <article class="admin-card">
      <div class="admin-terminal-toolbar">
        <h2 class="admin-section-title">Chart: Activity Throughput</h2>
        <span class="admin-chip"><span id="throughput-window">5m + 10m</span></span>
      </div>
      <p class="admin-muted admin-chart-meta">Jumlah event RAG per interval rolling. Samples: <span id="throughput-samples">0</span></p>
      <div class="admin-chart-wrap"><canvas id="chart-throughput" aria-label="RAG throughput chart for 5 and 10 minute intervals" role="img"></canvas></div>
    </article>
    <article class="admin-card">
      <div class="admin-terminal-toolbar">
        <h2 class="admin-section-title">Chart: Online User Trend</h2>
        <span class="admin-chip">Snapshots <span id="online-trend-samples">0</span></span>
      </div>
      <p class="admin-muted admin-chart-meta">Trend pengguna online non-staff berdasarkan snapshot infra.</p>
      <div class="admin-chart-wrap"><canvas id="chart-online-trend" aria-label="Online non staff user trend chart" role="img"></canvas></div>
    </article>
  </section>

  <section class="admin-row cols-2">
    <article class="admin-card">
      <h2 class="admin-section-title">RAG Events</h2>
      <div class="admin-table-wrap mt-10">
        <table class="admin-table">
          <thead><tr><th>Waktu</th><th>User</th><th>Mode</th><th>Retrieval</th><th>LLM</th><th>Fallback</th><th>Status</th></tr></thead>
          <tbody id="rag-events-body">
            {% for row in kpi_rag_events %}
              <tr>
                <td>{{ row.created_at|default:"-" }}</td>
                <td>{{ row.username|default:"-" }}</td>
                <td>{{ row.mode|default:"-" }}</td>
                <td>{{ row.retrieval_ms|default:"0" }}ms</td>
                <td>{{ row.llm_time_ms|default:"0" }}ms</td>
                <td>{% if row.fallback_used %}Ya{% else %}Tidak{% endif %}</td>
                <td>{{ row.status_code|default:"-" }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="7">Belum ada event RAG.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </article>

    <article class="admin-card">
      <h2 class="admin-section-title">Infrastructure Snapshots</h2>
      <div class="admin-table-wrap mt-10">
        <table class="admin-table">
          <thead><tr><th>Waktu</th><th>CPU</th><th>RAM</th><th>Disk</th><th>Session</th><th>Online</th></tr></thead>
          <tbody id="infra-snapshots-body">
            {% for row in kpi_infra_snapshots %}
              <tr>
                <td>{{ row.captured_at|default:"-" }}</td>
                <td>{{ row.cpu_percent|default:"0" }}%</td>
                <td>{{ row.memory_percent|default:"0" }}%</td>
                <td>{{ row.disk_percent|default:"0" }}%</td>
                <td>{{ row.active_sessions|default:"0" }}</td>
                <td>{{ row.online_users_non_staff|default:"0" }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="6">Belum ada snapshot infrastruktur.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </article>
  </section>

  <section class="admin-row cols-2">
    <article class="admin-card">
      <h2 class="admin-section-title">Online Users</h2>
      <div class="admin-table-wrap mt-10">
        <table class="admin-table">
          <thead><tr><th>Username</th><th>Role</th><th>IP</th><th>Login</th><th>Last Seen</th></tr></thead>
          <tbody id="online-users-body">
            {% for row in kpi_online_users %}
              <tr>
                <td>{{ row.username }}</td>
                <td>{% if row.is_staff %}Staff{% else %}User{% endif %}</td>
                <td>{{ row.ip_address|default:"-" }}</td>
                <td>{{ row.logged_in_at|default:"-" }}</td>
                <td>{{ row.last_seen_at|default:"-" }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="5">Belum ada user online.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </article>

    <article class="admin-card">
      <h2 class="admin-section-title">Recent Registered Users</h2>
      <div class="admin-table-wrap mt-10">
        <table class="admin-table">
          <thead><tr><th>Username</th><th>Role</th><th>Date Joined</th></tr></thead>
          <tbody id="recent-users-body">
            {% for row in kpi_recent_registered_users %}
              <tr>
                <td>{{ row.username }}</td>
                <td>{% if row.is_staff %}Staff{% else %}User{% endif %}</td>
                <td>{{ row.date_joined|default:"-" }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="3">Belum ada data user.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </article>
  </section>

  <section class="admin-card">
    <div class="admin-terminal-toolbar">
      <h2 class="admin-section-title">System Logs Preview</h2>
      <a class="admin-btn" href="{{ system_logs_url|default:'/admin/system-logs/' }}"><span class="bi bi-box-arrow-up-right"></span> Open Full Logs</a>
    </div>
    <div class="admin-log-grid">
      <div>
        <p class="admin-muted">app.log · <span id="app-size">{{ app_log_size_kb }}</span> KB · <span id="app-path">{{ app_log_path }}</span></p>
        <pre id="app-log" class="admin-terminal">{{ app_log_text }}</pre>
      </div>
      <div>
        <p class="admin-muted">audit.log · <span id="audit-size">{{ audit_log_size_kb }}</span> KB · <span id="audit-path">{{ audit_log_path }}</span></p>
        <pre id="audit-log" class="admin-terminal">{{ audit_log_text }}</pre>
      </div>
    </div>
  </section>

  <section class="admin-card">
    {% include "admin/app_list.html" with app_list=app_list show_changelinks=True %}
  </section>
</div>

<script>
(function () {
  "use strict";

  const qs = (id) => document.getElementById(id);
  const state = {
    pollSeconds: 5,
    isTicking: false,
    charts: {},
    chartData: {
      ragEvents: [],
      infraSnapshots: [],
      fallbackRate: 0,
      capacity: { registeredPct: 0, onlinePct: 0 },
    },
  };

  const el = {
    appLog: qs("app-log"),
    auditLog: qs("audit-log"),
    appPath: qs("app-path"),
    auditPath: qs("audit-path"),
    appSize: qs("app-size"),
    auditSize: qs("audit-size"),
    kpiRegistered: qs("kpi-registered"),
    kpiOnline: qs("kpi-online"),
    kpiTotalUsers: qs("kpi-total-users"),
    kpiTotalDocs: qs("kpi-total-docs"),
    kpiEmbeddedDocs: qs("kpi-embedded-docs"),
    kpiTotalMessages: qs("kpi-total-messages"),
    kpiTotalSessions: qs("kpi-total-sessions"),
    registeredRatio: qs("registered-ratio"),
    registeredLimit: qs("registered-limit"),
    registeredPct: qs("registered-pct"),
    registeredStatus: qs("registered-status"),
    onlineRatio: qs("online-ratio"),
    onlineLimit: qs("online-limit"),
    onlinePct: qs("online-pct"),
    onlineStatus: qs("online-status"),
    registeredProgress: qs("registered-progress"),
    onlineProgress: qs("online-progress"),
    registerLimitEnabled: qs("register-limit-enabled"),
    concurrentLimitEnabled: qs("concurrent-limit-enabled"),
    onlineUsersBody: qs("online-users-body"),
    recentUsersBody: qs("recent-users-body"),
    ragEventsBody: qs("rag-events-body"),
    infraSnapshotsBody: qs("infra-snapshots-body"),
    ragAvgRetrieval: qs("rag-avg-retrieval"),
    ragAvgLlm: qs("rag-avg-llm"),
    ragP95: qs("rag-p95"),
    ragFallbackInline: qs("rag-fallback-inline"),
    ragAvgRetrievalInline: qs("rag-avg-retrieval-inline"),
    ragAvgLlmInline: qs("rag-avg-llm-inline"),
    ragP95Inline: qs("rag-p95-inline"),
    infraCpu: qs("infra-cpu"),
    infraMem: qs("infra-mem"),
    infraDisk: qs("infra-disk"),
    kpiRagError: qs("kpi-rag-error"),
    kpiRagFallback: qs("kpi-rag-fallback"),
    kpiInfra: qs("kpi-infra"),
    kpiAlert: qs("kpi-alert"),
    alarmState: qs("alarm-state"),
    pollLabel: qs("poll-label"),
    throughputWindow: qs("throughput-window"),
    throughputSamples: qs("throughput-samples"),
    onlineTrendSamples: qs("online-trend-samples"),
    autoToggle: qs("monitor-auto"),
    refreshButton: qs("monitor-refresh"),
    chartCapacity: qs("chart-capacity"),
    chartRagReliability: qs("chart-rag-reliability"),
    chartRagLatency: qs("chart-rag-latency"),
    chartInfra: qs("chart-infra"),
    chartThroughput: qs("chart-throughput"),
    chartOnlineTrend: qs("chart-online-trend"),
  };

  const urls = {
    logs: "{% url 'admin:system_logs_tail' %}",
    users: "{% url 'admin:realtime_users' %}",
    overview: "{% url 'admin:realtime_overview' %}",
    rag: "{% url 'admin:realtime_rag' %}",
    infra: "{% url 'admin:realtime_infra' %}",
  };

  const configuredPoll = parseInt("{{ kpi_admin_poll_seconds|default:'5'|escapejs }}", 10);
  state.pollSeconds = Number.isFinite(configuredPoll) ? Math.max(configuredPoll, 3) : 5;
  if (el.pollLabel) el.pollLabel.textContent = String(state.pollSeconds);

  function escapeHtml(value) {
    return String(value || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/\"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  function setText(node, value) {
    if (node) node.textContent = value;
  }

  function formatTime(value) {
    if (!value) return "-";
    const date = new Date(value);
    if (Number.isNaN(date.getTime())) return "-";
    return date.toLocaleString("id-ID", {
      day: "2-digit",
      month: "short",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
    });
  }

  function resolveCapacityStatus(pct) {
    if (pct >= 100) return { label: "FULL", tone: "danger" };
    if (pct >= 80) return { label: "NEAR LIMIT", tone: "warning" };
    return { label: "OPEN", tone: "success" };
  }

  function applyChipTone(node, tone, label) {
    if (!node) return;
    node.className = "admin-chip " + tone;
    node.textContent = label;
  }

  function updateProgress(node, pct) {
    if (!node) return;
    const safePct = Math.max(0, Math.min(100, Number(pct) || 0));
    node.style.width = safePct + "%";
    node.className = "capacity-fill";
    if (safePct >= 100) node.classList.add("danger");
    else if (safePct >= 80) node.classList.add("warning");
  }

  function initializeProgressBars() {
    if (el.registeredProgress) updateProgress(el.registeredProgress, Number(el.registeredProgress.dataset.initialPct || 0));
    if (el.onlineProgress) updateProgress(el.onlineProgress, Number(el.onlineProgress.dataset.initialPct || 0));
  }

  function chartColors() {
    return {
      primary: "#2563eb",
      success: "#16a34a",
      warning: "#f59e0b",
      danger: "#e11d48",
      slate: "#64748b",
      cyan: "#0891b2",
    };
  }

  function initCharts() {
    if (typeof window.Chart === "undefined") return;
    const c = chartColors();
    const reduceMotion = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;

    if (reduceMotion) {
      Chart.defaults.animation = false;
      Chart.defaults.transitions.active.animation = false;
      Chart.defaults.transitions.resize.animation = false;
    }

    if (el.chartCapacity) {
      state.charts.capacity = new Chart(el.chartCapacity, {
        type: "bar",
        data: {
          labels: ["Registered", "Concurrent"],
          datasets: [{ label: "Usage %", data: [0, 0], backgroundColor: [c.primary, c.warning], borderRadius: 8 }],
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } }, plugins: { legend: { display: false } } },
      });
    }

    if (el.chartRagReliability) {
      state.charts.ragReliability = new Chart(el.chartRagReliability, {
        type: "doughnut",
        data: { labels: ["2xx", "4xx", "5xx"], datasets: [{ data: [0, 0, 0], backgroundColor: [c.success, c.warning, c.danger] }] },
        options: { responsive: true, maintainAspectRatio: false, cutout: "68%", plugins: { legend: { position: "bottom" } } },
      });
    }

    if (el.chartRagLatency) {
      state.charts.ragLatency = new Chart(el.chartRagLatency, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            { label: "Retrieval", data: [], borderColor: c.primary, backgroundColor: "rgba(37,99,235,.15)", tension: .35, fill: true },
            { label: "LLM", data: [], borderColor: c.cyan, backgroundColor: "rgba(8,145,178,.1)", tension: .35, fill: false },
          ],
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: "bottom" } } },
      });
    }

    if (el.chartInfra) {
      state.charts.infra = new Chart(el.chartInfra, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            { label: "CPU", data: [], borderColor: c.danger, tension: .3 },
            { label: "RAM", data: [], borderColor: c.warning, tension: .3 },
            { label: "Disk", data: [], borderColor: c.slate, tension: .3 },
          ],
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: "bottom" } }, scales: { y: { beginAtZero: true, max: 100 } } },
      });
    }

    if (el.chartThroughput) {
      state.charts.throughput = new Chart(el.chartThroughput, {
        type: "bar",
        data: {
          labels: [],
          datasets: [
            { label: "5m", data: [], backgroundColor: "rgba(37,99,235,.75)", borderRadius: 6 },
            { label: "10m", data: [], backgroundColor: "rgba(8,145,178,.70)", borderRadius: 6 },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: "bottom" } },
          scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
        },
      });
    }

    if (el.chartOnlineTrend) {
      state.charts.onlineTrend = new Chart(el.chartOnlineTrend, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Online non-staff",
              data: [],
              borderColor: c.primary,
              backgroundColor: "rgba(37,99,235,.15)",
              tension: 0.25,
              fill: true,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: "bottom" } },
          scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
        },
      });
    }
  }

  function updateCharts() {
    const events = state.chartData.ragEvents || [];
    const snapshots = state.chartData.infraSnapshots || [];

    if (state.charts.capacity) {
      state.charts.capacity.data.datasets[0].data = [state.chartData.capacity.registeredPct, state.chartData.capacity.onlinePct];
      state.charts.capacity.update("none");
    }

    if (state.charts.ragReliability) {
      let s2xx = 0, s4xx = 0, s5xx = 0;
      for (const row of events) {
        const code = Number(row.status_code || 0);
        if (code >= 500) s5xx += 1;
        else if (code >= 400) s4xx += 1;
        else s2xx += 1;
      }
      state.charts.ragReliability.data.datasets[0].data = [s2xx, s4xx, s5xx];
      state.charts.ragReliability.update("none");
    }

    if (state.charts.ragLatency) {
      const rows = [...events].slice(0, 10).reverse();
      state.charts.ragLatency.data.labels = rows.map((row) => formatTime(row.created_at));
      state.charts.ragLatency.data.datasets[0].data = rows.map((row) => Number(row.retrieval_ms || 0));
      state.charts.ragLatency.data.datasets[1].data = rows.map((row) => Number(row.llm_time_ms || 0));
      state.charts.ragLatency.update("none");
    }

    if (state.charts.infra) {
      const rows = [...snapshots].slice(0, 10).reverse();
      state.charts.infra.data.labels = rows.map((row) => formatTime(row.captured_at));
      state.charts.infra.data.datasets[0].data = rows.map((row) => Number(row.cpu_percent || 0));
      state.charts.infra.data.datasets[1].data = rows.map((row) => Number(row.memory_percent || 0));
      state.charts.infra.data.datasets[2].data = rows.map((row) => Number(row.disk_percent || 0));
      state.charts.infra.update("none");
    }

    if (state.charts.throughput) {
      const throughput5m = buildThroughputSeries(events, 5, 8);
      const throughput10m = buildThroughputSeries(events, 10, 8);
      state.charts.throughput.data.labels = throughput5m.labels;
      state.charts.throughput.data.datasets[0].data = throughput5m.values;
      state.charts.throughput.data.datasets[1].data = throughput10m.values;
      state.charts.throughput.update("none");
      setText(el.throughputSamples, String(events.length));
      setText(el.throughputWindow, "5m + 10m");
    }

    if (state.charts.onlineTrend) {
      const rows = [...snapshots].slice(0, 12).reverse();
      state.charts.onlineTrend.data.labels = rows.map((row) => formatTime(row.captured_at));
      state.charts.onlineTrend.data.datasets[0].data = rows.map((row) => Number(row.online_users_non_staff || 0));
      state.charts.onlineTrend.update("none");
      setText(el.onlineTrendSamples, String(rows.length));
    }
  }

  function buildThroughputSeries(events, intervalMinutes, bucketCount) {
    const intervalMs = intervalMinutes * 60 * 1000;
    const count = Math.max(bucketCount, 1);
    const now = Date.now();
    const start = now - (count - 1) * intervalMs;
    const buckets = Array.from({ length: count }, (_, i) => {
      const bucketStart = start + i * intervalMs;
      return { bucketStart, bucketEnd: bucketStart + intervalMs, value: 0 };
    });

    for (const row of events) {
      const ts = new Date(row.created_at || "").getTime();
      if (!Number.isFinite(ts)) continue;
      if (ts < start || ts >= now + intervalMs) continue;
      const idx = Math.floor((ts - start) / intervalMs);
      if (idx >= 0 && idx < buckets.length) buckets[idx].value += 1;
    }

    return {
      labels: buckets.map((bucket) => {
        const d = new Date(bucket.bucketStart);
        return d.toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit" });
      }),
      values: buckets.map((bucket) => bucket.value),
    };
  }

  async function fetchJson(url) {
    const response = await fetch(url, { credentials: "same-origin" });
    if (!response.ok) throw new Error("Request failed " + response.status + " for " + url);
    return response.json();
  }

  function renderCapacity(summary) {
    if (!summary) return;
    const registeredCount = Number(summary.registered_non_staff_count || 0);
    const regLimit = Math.max(Number(summary.registered_limit || 1), 1);
    const onlineCount = Number(summary.active_online_non_staff_count || 0);
    const onlineLimit = Math.max(Number(summary.concurrent_limit || 1), 1);

    const regPct = Math.min(100, Math.round((registeredCount / regLimit) * 100));
    const onlinePct = Math.min(100, Math.round((onlineCount / onlineLimit) * 100));
    state.chartData.capacity = { registeredPct: regPct, onlinePct: onlinePct };

    const regStatus = resolveCapacityStatus(regPct);
    const onlineStatus = resolveCapacityStatus(onlinePct);

    setText(el.kpiRegistered, String(registeredCount));
    setText(el.kpiOnline, String(onlineCount));
    setText(el.registeredRatio, String(registeredCount));
    setText(el.registeredLimit, String(regLimit));
    setText(el.registeredPct, String(regPct));
    setText(el.onlineRatio, String(onlineCount));
    setText(el.onlineLimit, String(onlineLimit));
    setText(el.onlinePct, String(onlinePct));
    setText(el.registerLimitEnabled, summary.registered_limit_enabled ? "ON" : "OFF");
    setText(el.concurrentLimitEnabled, summary.concurrent_limit_enabled ? "ON" : "OFF");

    applyChipTone(el.registeredStatus, regStatus.tone, regStatus.label);
    applyChipTone(el.onlineStatus, onlineStatus.tone, onlineStatus.label);
    updateProgress(el.registeredProgress, regPct);
    updateProgress(el.onlineProgress, onlinePct);
  }

  function renderKPI(summary) {
    if (!summary) return;

    setText(el.kpiRagError, String(summary.rag_error_rate_pct || 0) + "%");
    setText(el.kpiRagFallback, String(summary.rag_fallback_rate_pct || 0) + "%");
    setText(el.ragFallbackInline, String(summary.rag_fallback_rate_pct || 0));
    setText(el.ragAvgRetrieval, String(summary.avg_retrieval_ms || 0));
    setText(el.ragAvgLlm, String(summary.avg_llm_ms || 0));
    setText(el.ragAvgRetrievalInline, String(summary.avg_retrieval_ms || 0));
    setText(el.ragAvgLlmInline, String(summary.avg_llm_ms || 0));
    setText(el.infraCpu, String(summary.cpu_percent || 0));
    setText(el.infraMem, String(summary.memory_percent || 0));
    setText(el.infraDisk, String(summary.disk_percent || 0));
    setText(el.kpiInfra, [summary.cpu_percent || 0, summary.memory_percent || 0, summary.disk_percent || 0].join("/"));

    const alarm = String(summary.alert_state || "Normal");
    const tone = alarm === "Kritis" ? "danger" : alarm === "Waspada" ? "warning" : "success";
    applyChipTone(el.kpiAlert, tone, alarm);
    applyChipTone(el.alarmState, tone, alarm);
  }

  function renderOnlineUsers(rows) {
    if (!el.onlineUsersBody) return;
    if (!rows || rows.length === 0) {
      el.onlineUsersBody.innerHTML = "<tr><td colspan='5'>Belum ada user online.</td></tr>";
      return;
    }
    el.onlineUsersBody.innerHTML = rows.map((row) => {
      return "<tr>" +
        "<td>" + escapeHtml(row.username || "-") + "</td>" +
        "<td>" + (row.is_staff ? "Staff" : "User") + "</td>" +
        "<td>" + escapeHtml(row.ip_address || "-") + "</td>" +
        "<td>" + escapeHtml(formatTime(row.logged_in_at)) + "</td>" +
        "<td>" + escapeHtml(formatTime(row.last_seen_at)) + "</td>" +
      "</tr>";
    }).join("");
  }

  function renderRecentUsers(rows) {
    if (!el.recentUsersBody) return;
    if (!rows || rows.length === 0) {
      el.recentUsersBody.innerHTML = "<tr><td colspan='3'>Belum ada data user.</td></tr>";
      return;
    }
    el.recentUsersBody.innerHTML = rows.map((row) => {
      return "<tr>" +
        "<td>" + escapeHtml(row.username || "-") + "</td>" +
        "<td>" + (row.is_staff ? "Staff" : "User") + "</td>" +
        "<td>" + escapeHtml(formatTime(row.date_joined)) + "</td>" +
      "</tr>";
    }).join("");
  }

  function renderRagTable(events) {
    if (!el.ragEventsBody) return;
    if (!events || events.length === 0) {
      el.ragEventsBody.innerHTML = "<tr><td colspan='7'>Belum ada event RAG.</td></tr>";
      return;
    }
    el.ragEventsBody.innerHTML = events.map((row) => {
      return "<tr>" +
        "<td>" + escapeHtml(formatTime(row.created_at)) + "</td>" +
        "<td>" + escapeHtml(row.username || "-") + "</td>" +
        "<td>" + escapeHtml(row.mode || "-") + "</td>" +
        "<td>" + escapeHtml(String(row.retrieval_ms || 0)) + "ms</td>" +
        "<td>" + escapeHtml(String(row.llm_time_ms || 0)) + "ms</td>" +
        "<td>" + (row.fallback_used ? "Ya" : "Tidak") + "</td>" +
        "<td>" + escapeHtml(String(row.status_code || "-")) + "</td>" +
      "</tr>";
    }).join("");
  }

  function renderInfraTable(snapshots) {
    if (!el.infraSnapshotsBody) return;
    if (!snapshots || snapshots.length === 0) {
      el.infraSnapshotsBody.innerHTML = "<tr><td colspan='6'>Belum ada snapshot infrastruktur.</td></tr>";
      return;
    }
    el.infraSnapshotsBody.innerHTML = snapshots.map((row) => {
      return "<tr>" +
        "<td>" + escapeHtml(formatTime(row.captured_at)) + "</td>" +
        "<td>" + escapeHtml(String(row.cpu_percent || 0)) + "%</td>" +
        "<td>" + escapeHtml(String(row.memory_percent || 0)) + "%</td>" +
        "<td>" + escapeHtml(String(row.disk_percent || 0)) + "%</td>" +
        "<td>" + escapeHtml(String(row.active_sessions || 0)) + "</td>" +
        "<td>" + escapeHtml(String(row.online_users_non_staff || 0)) + "</td>" +
      "</tr>";
    }).join("");
  }

  function nearBottom(node) {
    if (!node) return false;
    return (node.scrollHeight - node.scrollTop - node.clientHeight) < 40;
  }

  function renderLogs(logPayload) {
    if (!logPayload) return;
    setText(el.appPath, logPayload.app_log_path || "-");
    setText(el.auditPath, logPayload.audit_log_path || "-");
    setText(el.appSize, String(logPayload.app_log_size_kb || 0));
    setText(el.auditSize, String(logPayload.audit_log_size_kb || 0));

    if (el.appLog) {
      const autoScroll = nearBottom(el.appLog);
      el.appLog.textContent = String(logPayload.app_log_text || "");
      if (autoScroll) el.appLog.scrollTop = el.appLog.scrollHeight;
    }
    if (el.auditLog) {
      const autoScroll = nearBottom(el.auditLog);
      el.auditLog.textContent = String(logPayload.audit_log_text || "");
      if (autoScroll) el.auditLog.scrollTop = el.auditLog.scrollHeight;
    }
  }

  async function tick() {
    if (state.isTicking) return;
    state.isTicking = true;

    const tasks = [
      fetchJson(urls.logs),
      fetchJson(urls.users),
      fetchJson(urls.overview),
      fetchJson(urls.rag),
      fetchJson(urls.infra),
    ];

    const [logsRes, usersRes, overviewRes, ragRes, infraRes] = await Promise.allSettled(tasks);

    if (logsRes.status === "fulfilled") renderLogs(logsRes.value);
    if (usersRes.status === "fulfilled") {
      const users = usersRes.value || {};
      renderCapacity(users.summary || {});
      renderOnlineUsers(users.online_users || []);
      renderRecentUsers(users.recent_registered_users || []);
    }
    if (overviewRes.status === "fulfilled") renderKPI((overviewRes.value || {}).summary || {});
    if (ragRes.status === "fulfilled") {
      const payload = ragRes.value || {};
      state.chartData.ragEvents = payload.events || [];
      renderRagTable(payload.events || []);
      setText(el.ragP95, String(payload.p95_retrieval_ms || 0));
      setText(el.ragP95Inline, String(payload.p95_retrieval_ms || 0));
    }
    if (infraRes.status === "fulfilled") {
      const payload = infraRes.value || {};
      state.chartData.infraSnapshots = payload.snapshots || [];
      renderInfraTable(payload.snapshots || []);
    }

    updateCharts();
    state.isTicking = false;
  }

  function boot() {
    initializeProgressBars();
    initCharts();

    if (el.refreshButton) {
      el.refreshButton.addEventListener("click", function () { tick(); });
    }

    tick();
    window.setInterval(function () {
      if (!el.autoToggle || el.autoToggle.checked) tick();
    }, state.pollSeconds * 1000);
  }

  window.addEventListener("load", boot);
})();
</script>
{% endblock %}

{% block sidebar %}{% endblock %}
